<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <div id='wx_pic' style='margin:0 auto;display:none;'>
    <img src='https://shengshuqiang.github.io/assets/pic300.jpg' />
  </div>
  <title>
    
      Android事件分发-来龙去脉 &middot; 盛书强
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Android事件分发-来龙去脉" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Android事件分发-来龙去脉</a>
          <small>盛书强</small>
        </h3>
      </header>

      <main>
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/2018/02/10/Android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91-%E6%9D%A5%E9%BE%99%E5%8E%BB%E8%84%89/">
        Android事件分发 来龙去脉
      </a>
    </h1>

    <time datetime="2018-02-10T00:00:00+08:00" class="post-date">10 Feb 2018</time>

    <!-- 添加目录 http://blog.csdn.net/hengwei_vc/article/details/47122103 -->

<script src="/javascripts/jquery-2.1.4.min.js" type="text/javascript"></script>

<script src="/javascripts/toc.js" type="text/javascript"></script>

<script type="text/javascript">
$(document).ready(function() {
    $('#toc').toc();
}); </script>

<div id="toc"></div>

<h1 id="situation">情境(Situation)</h1>

<ol>
<li>专注于移动互联网数年，作为高P的我【鼓掌】竟然对事件分发机制见招拆招，似懂非懂。不专业，没法忍。</li>
<li>View树的递归嵌套逻辑让广大一线同行云里雾里，手足无措。</li>
</ol>

<h1 id="complication">冲突(Complication)</h1>

<ol>
<li>网上好多相关主题的博客，描述信息点非常多（但是ACTION_CANCEL描述很少），看完后不明觉厉。</li>
<li>事件分发主要用于解决自定义炫酷控件以及滑动嵌套引发的冲突问题（程序傻傻分不清是横滑还是竖滑），发现同行各种写法都有，雷无处不在【人在家中坐，锅从天上来】。</li>
</ol>

<p><strong>我的机会来了</strong>【大笑】</p>

<h1 id="question">疑问(Question)</h1>

<ol>
<li>有没有体系化剖析套路？</li>
<li>指出常见错误，给出最佳实践？</li>
<li>清晰明了的给出一张图，便于查阅？</li>
<li>“鱼”和“渔”可以兼得？</li>
</ol>

<h1 id="answer">答案(Answer)</h1>

<h2 id="part-6542811a1fd">剖析</h2>

<h3 id="part-65431c264f7">论点</h3>

<h4 id="part-2e093f17d1156991">约法三章</h4>

<ol>
<li>限于个人水平，本文只包含单点触控事件（ACTION_DOWN，ACTION_MOVE，ACTION_UP，ACTION_CANCEL）。</li>
<li>Window类相关的我不会，肤浅的认为和事件分发关系不大（求大牛点拨），直接跳过。</li>
<li>一家之言，姑妄言之，姑妄听之。</li>
</ol>

<h4 id="part-b8a9b07">点</h4>

<ol>
<li><a href="https://developer.android.com/reference/android/view/MotionEvent.html">事件流一致性保证(Consistency Guarantees)</a>：按下开始，中间可能伴随着移动，松开或者取消结束。ACTION_DOWN -&gt; ACTION_MOVE(*) -&gt; ACTION_UP/ACTION_CANCEL。</li>
<li>View类的dispatchTouchEvent方法完成事件的消费处理，ViewGroup的dispatchTouchEvent方法完成事件的分发处理。正常情况下不建议重写该方法改变系统事件分发机制。</li>
<li>ViewGroup类的onInterceptTouchEvent方法完成事件的拦截处理。事件分发路径上的ViewGroup，在ACTION_DOWN或者不是自己直接消费事件时一定会调用onInterceptTouchEvent方法。</li>
<li>View类的onTouchEvent方法完成具体处理事件消费，即触发点击监听（OnClickListener）和长时间点击监听(OnLongClickListener)以及按键状态、焦点相关处理。

<ol>
<li>如果设置了OnTouchListener，会先调用OnTouchListener，如果该监听onTouch返回true，则不会调用onTouchEvent，直接返回已消费；</li>
<li>如果设置了TouchDelegate ，onTouchEvent中会先调用TouchDelegate，如果该类onTouchEvent返回true，则直接返回已消费；</li>
<li>如果View 可点击，执行onTouchEvent中事件处理，并返回true；

<ol>
<li>ACTION_DOWN：置按键标志位为按下状态，并触发延时（500ms）执行长按点击事件。</li>
<li>ACTION_MOVE：如果按键坐标超出该控件区域，则置按键标志位为非按下状态，并且移除ACTION_DOWN触发的延时执行长按点击事件。</li>
<li>ACTION_UP：如果按键标志位为按下状态，并且ACTION_DOWN触发的长按点击事件还未执行，则移除长按点击事件，执行点击事件。</li>
<li>ACTION_CANCEL：置按键标志位为非按下状态，移除ACTION_DOWN触发的延时执行长按点击事件。</li>
</ol></li>
<li>否则不可点击，返回false；</li>
</ol></li>
</ol>

<h3 id="part-65431c26216">论据</h3>

<p>基于<strong>Android 8.0 （API Level 28）</strong>源码解析</p>

<h4 id="part-2bf1db217582440b">人机交互</h4>

<p><img src="http://localhost:4000/assets/%E4%BA%BA%E6%9C%BA%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="人机交互流程图"></p>

<p><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91Java%E6%A0%88.png" alt="事件分发Java栈"></p>

<p><strong>赏析</strong></p>

<ol>
<li>用户的按键行为-&gt;手机传感器-&gt;ViewRootImpl-&gt;DecorView-&gt;WindowCallbackWrapper-&gt;Activity-&gt;PhoneWindow-&gt;DecorView-&gt;ViewGroup*-&gt;View-&gt;程序员的代码逻辑-&gt;硬件（显示器、扬声器等）响应输出-&gt;用户感知</li>
</ol>

<h4 id="view">View树</h4>

<p><img src="http://localhost:4000/assets/AndroidView%E6%A0%91%E5%B8%83%E5%B1%80%E7%BB%93%E6%9E%84.png" alt="AndroidView树布局结构"></p>

<p><strong>赏析</strong></p>

<ol>
<li>View是由树形结构组织，节点为ViewGroup或者View。ViewGroup可以包含多个子节点，View没有子节点。</li>
<li>Android中View树的根节点为DecorView（父View为FrameLayout，属于ViewGroup）。</li>
<li>Android中用户可自定义的View子树根节点id为“android:id/content”。</li>
</ol>

<h4 id="part-6542fa40cf6">类图</h4>

<p><img src="http://localhost:4000/assets/View%E5%92%8CViewGroup%E7%B1%BB%E5%9B%BE.png" alt="View和ViewGroup类图"></p>

<p><strong>赏析</strong></p>

<ol>
<li>ViewRootImpl是Android层逻辑起始点，用于接收来自系统底层的事件消息。相当于View管理类，本身不是View。（BTW：View绘制流程的三部曲（measure、layout、draw）也由该类触发的。）</li>
<li>DecorView是Android View树的根节点，持有window对象。本身能够直接进行真正事件分发能力（继承了父类ViewGroup和View的事件分发处理功能），但是事件分发会直接调用window，间接传递到Activity的事件分发，后续会由Activity回调DecorView的真正事件分发能力。对应图中的环形依赖。</li>
<li>Activity是Android中的页面，真正的事件分发由该类的dispatchTouchEvent触发。（Easter Eggs：如果你想让用户操作不了你的界面，蒙一层透明的View是不是有点low，直接重写该方法就可以控制。）</li>
<li>ViewGroup负责事件分发和拦截处理。按下事件和后续事件（移动、释放或者取消）处理不相同。

<ol>
<li>按下事件，先判断是否拦截。

<ol>
<li>如果不拦截的话，分发事件寻找目标消费子View（逆序遍历子View，递归调用子View的事件分发，判断是否有子View消费。mFirstTouchTarget存储目标消费子View对象）。

<ol>
<li>如果有子View消费，则目标子View消费事件。</li>
<li>否则自己尝试消费事件。</li>
</ol></li>
<li>否则直接自己尝试消费事件。</li>
</ol></li>
<li>后续事件

<ol>
<li>如果按下事件找到了目标消费子View，则判断是否拦截，否则不拦截。</li>
<li>如果有目标消费子View，则根据是否拦截。

<ol>
<li>如果没有拦截，正常传送后续事件；</li>
<li>如果有拦截，则当前事件转换为取消事件发送给目标消费子View，并且重置目标消费子View为空，接下来的后续事件直接自己尝试消费事件（不管是否消费，后续事件都会接收到&amp;尝试处理事件分发）；</li>
</ol></li>
<li>否则自己尝试消费事件。（不会调用是否拦截，其实拦截或者不拦截，都是自己消费事件。）</li>
</ol></li>
</ol></li>
<li>View负责事件消费事件处理。

<ol>
<li>调用mOnTouchListener的onTouch。

<ol>
<li>如果消费，直接返回true；</li>
<li>否则，继续调用onTouchEvent方法；

<ol>
<li>如果为启用的（enable），返回可点击（clickable）。</li>
<li>否则，调用mTouchDelegate的onTouchEvent。

<ol>
<li>如果消费，直接返回true；</li>
<li>否则，

<ol>
<li></li>
<li></li>
</ol></li>
</ol></li>
</ol></li>
</ol></li>
</ol></li>
</ol>

<h4 id="part-6542d68b860">注释</h4>

<h5 id="decorview">DecorView</h5>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="sr">/**
  * Decor的意思是：装饰，布置。
  * View树的根节点。
  * 事件分发的启点，ViewRootImpl最先调用dispatchPointerEvent（实现在父类View里面）。
  * 事件调用在DecorView里面形成了一个环。（先通过Window交由Activity分发，Activity再调用DecorView中的真正事件分发方法）
  */</span>
<span class="kp">public</span> <span class="k">class</span> <span class="nc">DecorView</span> <span class="n">extends</span> <span class="no">FrameLayout</span>  <span class="p">{</span>
    <span class="kp">private</span> <span class="no">PhoneWindow</span> <span class="n">mWindow</span><span class="p">;</span>

    <span class="vi">@Override</span>
    <span class="kp">public</span> <span class="n">boolean</span> <span class="n">dispatchTouchEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="sr">//</span> <span class="no">DecorView</span><span class="err">直接覆盖</span><span class="no">ViewGroup</span><span class="err">的事件分发实现，其实这只是饶了个圈，</span>
        <span class="sr">//</span> <span class="err">正真的事件分发会由</span><span class="no">Activity</span><span class="err">回调到</span><span class="n">superDispatchTouchEvent</span><span class="err">（</span><span class="no">ViewGroup</span><span class="err">的事件分发处理）。</span>
        <span class="sr">//</span> <span class="err">调用</span><span class="no">Window</span><span class="err">的</span><span class="no">WindowCallbackWrapper</span><span class="err">对象继续分发。</span>
        <span class="n">final</span> <span class="no">Window</span><span class="o">.</span><span class="no">Callback</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">mWindow</span><span class="p">.</span><span class="nf">getCallback</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">cb</span> <span class="o">!=</span> <span class="n">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mWindow</span><span class="p">.</span><span class="nf">isDestroyed</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">mFeatureId</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="p">?</span> <span class="n">cb</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span> <span class="p">:</span> <span class="k">super</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kp">public</span> <span class="n">boolean</span> <span class="n">superDispatchTouchEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="sr">//</span> <span class="err">调用父类</span><span class="no">ViewGroup</span><span class="err">进行事件分发处理。</span>
        <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
<h5 id="windowcallbackwrapper">WindowCallbackWrapper</h5>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="sr">/**
  * Wrapper的意思是包装材料。
  * 实实在在的一个壳，包裹着Activity。
  */</span>
<span class="kp">public</span> <span class="k">class</span> <span class="nc">WindowCallbackWrapper</span> <span class="n">implements</span> <span class="no">Window</span><span class="o">.</span><span class="no">Callback</span>   <span class="p">{</span>
    <span class="n">final</span> <span class="no">Window</span><span class="o">.</span><span class="no">Callback</span> <span class="n">mWrapped</span><span class="p">;</span>

    <span class="vi">@Override</span>
    <span class="kp">public</span> <span class="n">boolean</span> <span class="n">dispatchTouchEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="sr">//</span> <span class="err">交给</span><span class="no">Callback</span><span class="err">（具体对象为</span><span class="no">Activity</span><span class="err">）接力事件分发。</span>
        <span class="k">return</span> <span class="n">mWrapped</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
<h5 id="activity">Activity</h5>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="sr">/**
  * Activity和View不一样，Activity就是一个壳，没有事件分发机制，View树如果没有消费，Activity捡个漏。
  */</span>
<span class="kp">public</span> <span class="k">class</span> <span class="nc">Activity</span> <span class="n">implements</span> <span class="no">Window</span><span class="o">.</span><span class="no">Callback</span>  <span class="p">{</span>
    <span class="kp">private</span> <span class="no">Window</span> <span class="n">mWindow</span><span class="p">;</span>

    <span class="kp">public</span> <span class="n">boolean</span> <span class="n">dispatchTouchEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="nf">getAction</span><span class="p">()</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_DOWN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">onUserInteraction</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="sr">//</span> <span class="err">交给</span><span class="no">Window</span><span class="err">（具体对象为</span><span class="no">PhoneWindow</span><span class="err">）接力事件分发。</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">getWindow</span><span class="p">().</span><span class="nf">superDispatchTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span> <span class="p">{</span>
            <span class="sr">//</span> <span class="no">View</span><span class="err">树消费掉事件</span>
            <span class="k">return</span> <span class="kp">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="sr">//</span> <span class="err">如果</span><span class="no">View</span><span class="err">树没有消费事件，</span><span class="no">Activity</span><span class="err">消费事件的机会来了。</span>
        <span class="sr">//</span> <span class="err">启示：如果</span><span class="no">View</span><span class="err">树消费事件，在按下事件的后续事件中，如果父</span><span class="no">ViewGroup</span><span class="err">进行拦截，</span>
        <span class="sr">//</span> <span class="err">虽然后续返回的消费状态对整个事件流没有影响，但是会对</span><span class="no">Activity</span><span class="err">有影响（</span><span class="no">View</span><span class="err">数不消费，</span><span class="no">Activity</span><span class="err">有机会消费）。</span>
        <span class="k">return</span> <span class="n">onTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kp">public</span> <span class="n">boolean</span> <span class="n">onTouchEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="sr">//</span> <span class="err">事件消费处理，系统默认基本不干啥</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mWindow</span><span class="p">.</span><span class="nf">shouldCloseOnTouch</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">finish</span><span class="p">();</span>
            <span class="k">return</span> <span class="kp">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kp">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
<h5 id="phonewindow">PhoneWindow</h5>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="sr">/**
  * PhoneWindow也是一个壳，将事件转回给DecorView分发处理。
  */</span>
<span class="kp">public</span> <span class="k">class</span> <span class="nc">PhoneWindow</span> <span class="n">extends</span> <span class="no">Window</span>  <span class="p">{</span>
    <span class="kp">private</span> <span class="no">DecorView</span> <span class="n">mDecor</span><span class="p">;</span>

    <span class="vi">@Override</span>
    <span class="kp">public</span> <span class="n">boolean</span> <span class="n">superDispatchTouchEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="sr">//</span> <span class="err">交给</span><span class="no">DecorView</span><span class="err">接力事件分发（自此，环形结束，开始</span><span class="no">ViewGroup</span><span class="err">和</span><span class="no">View</span><span class="err">中事件分发和消费闪亮登场）。</span>
        <span class="k">return</span> <span class="n">mDecor</span><span class="p">.</span><span class="nf">superDispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
<h5 id="viewgroup">ViewGroup</h5>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="sr">/**
  * ViewGroup，View容器的意思。
  * dispatchTouchEvent完成时间分发逻辑。
  * onInterceptTouchEvent：为事件拦截接口，父控件可以主动截留事件自己消费，否则只能等子Viwe树都不消费才能捡漏。【有控制权就是爸爸】
  */</span>
<span class="kp">public</span> <span class="n">abstract</span> <span class="k">class</span> <span class="nc">ViewGroup</span> <span class="n">extends</span> <span class="no">View</span> <span class="n">implements</span> <span class="no">ViewParent</span>  <span class="p">{</span>

    <span class="vi">@Override</span>
    <span class="kp">public</span> <span class="n">boolean</span> <span class="n">dispatchTouchEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">ev</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mInputEventConsistencyVerifier</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">mInputEventConsistencyVerifier</span><span class="p">.</span><span class="nf">onTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="sr">//</span> <span class="no">If</span> <span class="n">the</span> <span class="n">event</span> <span class="n">targets</span> <span class="n">the</span> <span class="n">accessibility</span> <span class="n">focused</span> <span class="n">view</span> <span class="n">and</span> <span class="n">this</span> <span class="n">is</span> <span class="n">it</span><span class="p">,</span> <span class="n">start</span>
        <span class="sr">//</span> <span class="n">normal</span> <span class="n">event</span> <span class="n">dispatch</span><span class="o">.</span> <span class="no">Maybe</span> <span class="n">a</span> <span class="n">descendant</span> <span class="n">is</span> <span class="n">what</span> <span class="n">will</span> <span class="n">handle</span> <span class="n">the</span> <span class="n">click</span><span class="p">.</span>
        <span class="nf">if</span> <span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="nf">isTargetAccessibilityFocus</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">isAccessibilityFocusedViewOrHost</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">ev</span><span class="p">.</span><span class="nf">setTargetAccessibilityFocus</span><span class="p">(</span><span class="kp">false</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">boolean</span> <span class="n">handled</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">onFilterTouchEventForSecurity</span><span class="p">(</span><span class="n">ev</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">final</span> <span class="n">int</span> <span class="n">action</span> <span class="o">=</span> <span class="n">ev</span><span class="p">.</span><span class="nf">getAction</span><span class="p">();</span>
            <span class="n">final</span> <span class="n">int</span> <span class="n">actionMasked</span> <span class="o">=</span> <span class="n">action</span> <span class="o">&amp;</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_MASK</span><span class="p">;</span>

            <span class="sr">//</span> <span class="no">Handle</span> <span class="n">an</span> <span class="n">initial</span> <span class="n">down</span><span class="p">.</span>
            <span class="nf">if</span> <span class="p">(</span><span class="n">actionMasked</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_DOWN</span><span class="p">)</span> <span class="p">{</span>
                <span class="sr">//</span> <span class="no">Throw</span> <span class="n">away</span> <span class="n">all</span> <span class="n">previous</span> <span class="n">state</span> <span class="k">when</span> <span class="n">starting</span> <span class="n">a</span> <span class="n">new</span> <span class="n">touch</span> <span class="n">gesture</span><span class="p">.</span>
                <span class="nf">/</span><span class="o">/</span> <span class="no">The</span> <span class="n">framework</span> <span class="n">may</span> <span class="n">have</span> <span class="n">dropped</span> <span class="n">the</span> <span class="n">up</span> <span class="n">or</span> <span class="n">cancel</span> <span class="n">event</span> <span class="k">for</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">gesture</span>
                <span class="sr">//</span> <span class="n">due</span> <span class="n">to</span> <span class="n">an</span> <span class="n">app</span> <span class="n">switch</span><span class="p">,</span> <span class="no">ANR</span><span class="p">,</span> <span class="n">or</span> <span class="n">some</span> <span class="n">other</span> <span class="n">state</span> <span class="n">change</span><span class="p">.</span>
                <span class="nf">/</span><span class="o">/</span> <span class="err">按下事件会进行状态重置。（才有外部拦截法解决滑动冲突的小伙伴要注意这里重置，拦截调用必须要做此之后。）</span>
                <span class="n">cancelAndClearTouchTargets</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
                <span class="n">resetTouchState</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="sr">//</span> <span class="no">Check</span> <span class="k">for</span> <span class="n">interception</span><span class="p">.</span>
            <span class="nf">/</span><span class="o">/</span> <span class="err">是否拦截判断</span>
            <span class="n">final</span> <span class="n">boolean</span> <span class="n">intercepted</span><span class="p">;</span>
            <span class="sr">//</span> <span class="err">拦截条件</span><span class="mi">1</span><span class="err">，要么是按下事件，要么自己不直接消费事件。</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">actionMasked</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_DOWN</span>
                    <span class="o">||</span> <span class="n">mFirstTouchTarget</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="sr">//</span> <span class="err">拦截条件</span><span class="mi">2</span><span class="err">，允许拦截开关打开。</span>
                <span class="sr">//</span><span class="err">（默认状态是打开的，其他</span><span class="no">View</span><span class="err">可以调用</span><span class="n">requestDisallowInterceptTouchEvent</span><span class="err">进行控制，</span>
                <span class="sr">//</span> <span class="err">多为子</span><span class="no">View</span><span class="err">掉父</span><span class="no">View</span><span class="err">，滑动冲突外部拦截法就是靠调用这个接口控制父</span><span class="no">View</span><span class="err">拦截）。【爸爸的权利也不是绝对的】</span>
                <span class="n">final</span> <span class="n">boolean</span> <span class="n">disallowIntercept</span> <span class="o">=</span> <span class="p">(</span><span class="n">mGroupFlags</span> <span class="o">&amp;</span> <span class="no">FLAG_DISALLOW_INTERCEPT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disallowIntercept</span><span class="p">)</span> <span class="p">{</span>
                    <span class="sr">//</span> <span class="err">满足两个条件才会调到拦截控制（只能通过重写该方法，默认不拦截）。</span>
                    <span class="n">intercepted</span> <span class="o">=</span> <span class="n">onInterceptTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
                    <span class="n">ev</span><span class="p">.</span><span class="nf">setAction</span><span class="p">(</span><span class="n">action</span><span class="p">);</span> <span class="sr">//</span> <span class="n">restore</span> <span class="n">action</span> <span class="k">in</span> <span class="k">case</span> <span class="n">it</span> <span class="n">was</span> <span class="n">changed</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">intercepted</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="sr">//</span> <span class="no">There</span> <span class="n">are</span> <span class="n">no</span> <span class="n">touch</span> <span class="n">targets</span> <span class="n">and</span> <span class="n">this</span> <span class="n">action</span> <span class="n">is</span> <span class="n">not</span> <span class="n">an</span> <span class="n">initial</span> <span class="n">down</span>
                <span class="sr">//</span> <span class="n">so</span> <span class="n">this</span> <span class="n">view</span> <span class="n">group</span> <span class="n">continues</span> <span class="n">to</span> <span class="n">intercept</span> <span class="n">touches</span><span class="p">.</span>
                <span class="nf">/</span><span class="o">/</span> <span class="err">这种场景我没有遇到过，可能多点触控会调到【说错了当我放屁】</span>
                <span class="n">intercepted</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="sr">//</span> <span class="no">If</span> <span class="n">intercepted</span><span class="p">,</span> <span class="n">start</span> <span class="n">normal</span> <span class="n">event</span> <span class="n">dispatch</span><span class="o">.</span> <span class="no">Also</span> <span class="k">if</span> <span class="n">there</span> <span class="n">is</span> <span class="n">already</span>
            <span class="sr">//</span> <span class="n">a</span> <span class="n">view</span> <span class="n">that</span> <span class="n">is</span> <span class="n">handling</span> <span class="n">the</span> <span class="n">gesture</span><span class="p">,</span> <span class="k">do</span> <span class="n">normal</span> <span class="n">event</span> <span class="n">dispatch</span><span class="p">.</span>
            <span class="nf">if</span> <span class="p">(</span><span class="n">intercepted</span> <span class="o">||</span> <span class="n">mFirstTouchTarget</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ev</span><span class="p">.</span><span class="nf">setTargetAccessibilityFocus</span><span class="p">(</span><span class="kp">false</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="sr">//</span> <span class="no">Check</span> <span class="k">for</span> <span class="n">cancelation</span><span class="p">.</span>
            <span class="nf">final</span> <span class="n">boolean</span> <span class="n">canceled</span> <span class="o">=</span> <span class="n">resetCancelNextUpFlag</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
                    <span class="o">||</span> <span class="n">actionMasked</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_CANCEL</span><span class="p">;</span>

            <span class="sr">//</span> <span class="no">Update</span> <span class="n">list</span> <span class="n">of</span> <span class="n">touch</span> <span class="n">targets</span> <span class="k">for</span> <span class="n">pointer</span> <span class="n">down</span><span class="p">,</span> <span class="k">if</span> <span class="n">needed</span><span class="p">.</span>
            <span class="nf">final</span> <span class="n">boolean</span> <span class="nb">split</span> <span class="o">=</span> <span class="p">(</span><span class="n">mGroupFlags</span> <span class="o">&amp;</span> <span class="no">FLAG_SPLIT_MOTION_EVENTS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="no">TouchTarget</span> <span class="n">newTouchTarget</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
            <span class="n">boolean</span> <span class="n">alreadyDispatchedToNewTouchTarget</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
            <span class="sr">//</span> <span class="err">递归查找目标消费子</span><span class="no">View</span><span class="err">条件</span><span class="mi">1</span><span class="err">：事件没有被取消，也没有被拦截</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">canceled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">intercepted</span><span class="p">)</span> <span class="p">{</span>

                <span class="sr">//</span> <span class="no">If</span> <span class="n">the</span> <span class="n">event</span> <span class="n">is</span> <span class="n">targeting</span> <span class="n">accessiiblity</span> <span class="n">focus</span> <span class="n">we</span> <span class="n">give</span> <span class="n">it</span> <span class="n">to</span> <span class="n">the</span>
                <span class="sr">//</span> <span class="n">view</span> <span class="n">that</span> <span class="n">has</span> <span class="n">accessibility</span> <span class="n">focus</span> <span class="n">and</span> <span class="k">if</span> <span class="n">it</span> <span class="n">does</span> <span class="n">not</span> <span class="n">handle</span> <span class="n">it</span>
                <span class="sr">//</span> <span class="n">we</span> <span class="n">clear</span> <span class="n">the</span> <span class="n">flag</span> <span class="n">and</span> <span class="n">dispatch</span> <span class="n">the</span> <span class="n">event</span> <span class="n">to</span> <span class="n">all</span> <span class="n">children</span> <span class="n">as</span> <span class="n">usual</span><span class="p">.</span>
                <span class="nf">/</span><span class="o">/</span> <span class="no">We</span> <span class="n">are</span> <span class="n">looking</span> <span class="n">up</span> <span class="n">the</span> <span class="n">accessibility</span> <span class="n">focused</span> <span class="n">host</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">keeping</span>
                <span class="sr">//</span> <span class="n">state</span> <span class="n">since</span> <span class="n">these</span> <span class="n">events</span> <span class="n">are</span> <span class="n">very</span> <span class="n">rare</span><span class="o">.</span>
                <span class="no">View</span> <span class="n">childWithAccessibilityFocus</span> <span class="o">=</span> <span class="n">ev</span><span class="p">.</span><span class="nf">isTargetAccessibilityFocus</span><span class="p">()</span>
                        <span class="p">?</span> <span class="n">findChildWithAccessibilityFocus</span><span class="p">()</span> <span class="p">:</span> <span class="n">null</span><span class="p">;</span>
                <span class="sr">//</span> <span class="err">递归查找目标消费子</span><span class="no">View</span><span class="err">条件</span><span class="mi">2</span><span class="err">：事件必须是按下事件。【多点触控的不讨论，关键是我也不会】</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">actionMasked</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_DOWN</span>
                        <span class="o">||</span> <span class="p">(</span><span class="nb">split</span> <span class="o">&amp;&amp;</span> <span class="n">actionMasked</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_POINTER_DOWN</span><span class="p">)</span>
                        <span class="o">||</span> <span class="n">actionMasked</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_HOVER_MOVE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">final</span> <span class="n">int</span> <span class="n">actionIndex</span> <span class="o">=</span> <span class="n">ev</span><span class="p">.</span><span class="nf">getActionIndex</span><span class="p">();</span> <span class="sr">//</span> <span class="n">always</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">down</span>
                    <span class="n">final</span> <span class="n">int</span> <span class="n">idBitsToAssign</span> <span class="o">=</span> <span class="nb">split</span> <span class="p">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ev</span><span class="p">.</span><span class="nf">getPointerId</span><span class="p">(</span><span class="n">actionIndex</span><span class="p">)</span>
                            <span class="p">:</span> <span class="no">TouchTarget</span><span class="o">.</span><span class="no">ALL_POINTER_IDS</span><span class="p">;</span>

                    <span class="sr">//</span> <span class="no">Clean</span> <span class="n">up</span> <span class="n">earlier</span> <span class="n">touch</span> <span class="n">targets</span> <span class="k">for</span> <span class="n">this</span> <span class="n">pointer</span> <span class="nb">id</span> <span class="k">in</span> <span class="k">case</span> <span class="n">they</span>
                    <span class="sr">//</span> <span class="n">have</span> <span class="n">become</span> <span class="n">out</span> <span class="n">of</span> <span class="n">sync</span><span class="p">.</span>
                    <span class="nf">removePointersFromTouchTargets</span><span class="p">(</span><span class="n">idBitsToAssign</span><span class="p">);</span>

                    <span class="n">final</span> <span class="n">int</span> <span class="n">childrenCount</span> <span class="o">=</span> <span class="n">mChildrenCount</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">newTouchTarget</span> <span class="o">==</span> <span class="n">null</span> <span class="o">&amp;&amp;</span> <span class="n">childrenCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">final</span> <span class="n">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ev</span><span class="p">.</span><span class="nf">getX</span><span class="p">(</span><span class="n">actionIndex</span><span class="p">);</span>
                        <span class="n">final</span> <span class="n">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ev</span><span class="p">.</span><span class="nf">getY</span><span class="p">(</span><span class="n">actionIndex</span><span class="p">);</span>
                        <span class="sr">//</span> <span class="no">Find</span> <span class="n">a</span> <span class="n">child</span> <span class="n">that</span> <span class="n">can</span> <span class="n">receive</span> <span class="n">the</span> <span class="n">event</span><span class="p">.</span>
                        <span class="nf">/</span><span class="o">/</span> <span class="no">Scan</span> <span class="n">children</span> <span class="n">from</span> <span class="n">front</span> <span class="n">to</span> <span class="n">back</span><span class="p">.</span>
                        <span class="nf">/</span><span class="o">/</span> <span class="err">可以重置顺序，和事件分发关系不大，跳过</span>
                        <span class="n">final</span> <span class="no">ArrayList</span><span class="o">&lt;</span><span class="no">View</span><span class="o">&gt;</span> <span class="n">preorderedList</span> <span class="o">=</span> <span class="n">buildTouchDispatchChildList</span><span class="p">();</span>
                        <span class="n">final</span> <span class="n">boolean</span> <span class="n">customOrder</span> <span class="o">=</span> <span class="n">preorderedList</span> <span class="o">==</span> <span class="n">null</span>
                                <span class="o">&amp;&amp;</span> <span class="n">isChildrenDrawingOrderEnabled</span><span class="p">();</span>
                        <span class="n">final</span> <span class="no">View</span><span class="p">[]</span> <span class="n">children</span> <span class="o">=</span> <span class="n">mChildren</span><span class="p">;</span>
                        <span class="sr">//</span> <span class="err">逆序遍历，后面的</span><span class="no">View</span><span class="err">后绘制，盖在上面</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">childrenCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">final</span> <span class="n">int</span> <span class="n">childIndex</span> <span class="o">=</span> <span class="n">getAndVerifyPreorderedIndex</span><span class="p">(</span>
                                    <span class="n">childrenCount</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">customOrder</span><span class="p">);</span>
                            <span class="n">final</span> <span class="no">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">getAndVerifyPreorderedView</span><span class="p">(</span>
                                    <span class="n">preorderedList</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">childIndex</span><span class="p">);</span>

                            <span class="sr">//</span> <span class="no">If</span> <span class="n">there</span> <span class="n">is</span> <span class="n">a</span> <span class="n">view</span> <span class="n">that</span> <span class="n">has</span> <span class="n">accessibility</span> <span class="n">focus</span> <span class="n">we</span> <span class="n">want</span> <span class="n">it</span>
                            <span class="sr">//</span> <span class="n">to</span> <span class="n">get</span> <span class="n">the</span> <span class="n">event</span> <span class="n">first</span> <span class="n">and</span> <span class="k">if</span> <span class="n">not</span> <span class="n">handled</span> <span class="n">we</span> <span class="n">will</span> <span class="n">perform</span> <span class="n">a</span>
                            <span class="sr">//</span> <span class="n">normal</span> <span class="n">dispatch</span><span class="o">.</span> <span class="no">We</span> <span class="n">may</span> <span class="k">do</span> <span class="n">a</span> <span class="n">double</span> <span class="n">iteration</span> <span class="n">but</span> <span class="n">this</span> <span class="n">is</span>
                            <span class="sr">//</span> <span class="n">safer</span> <span class="n">given</span> <span class="n">the</span> <span class="n">timeframe</span><span class="p">.</span>
                            <span class="nf">if</span> <span class="p">(</span><span class="n">childWithAccessibilityFocus</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">childWithAccessibilityFocus</span> <span class="o">!=</span> <span class="n">child</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="n">continue</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="n">childWithAccessibilityFocus</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
                                <span class="n">i</span> <span class="o">=</span> <span class="n">childrenCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="sr">//</span> <span class="err">消费事件</span><span class="no">View</span><span class="err">资格</span><span class="mi">1</span><span class="err">：事件的坐标在</span><span class="no">View</span><span class="err">区域内。</span>
                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">canViewReceivePointerEvents</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                                    <span class="o">||</span> <span class="o">!</span><span class="n">isTransformedTouchPointInView</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">null</span><span class="p">))</span> <span class="p">{</span>
                                <span class="n">ev</span><span class="p">.</span><span class="nf">setTargetAccessibilityFocus</span><span class="p">(</span><span class="kp">false</span><span class="p">);</span>
                                <span class="n">continue</span><span class="p">;</span>
                            <span class="p">}</span>

                            <span class="n">newTouchTarget</span> <span class="o">=</span> <span class="n">getTouchTarget</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">newTouchTarget</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                                <span class="sr">//</span> <span class="no">Child</span> <span class="n">is</span> <span class="n">already</span> <span class="n">receiving</span> <span class="n">touch</span> <span class="n">within</span> <span class="n">its</span> <span class="n">bounds</span><span class="p">.</span>
                                <span class="nf">/</span><span class="o">/</span> <span class="no">Give</span> <span class="n">it</span> <span class="n">the</span> <span class="n">new</span> <span class="n">pointer</span> <span class="k">in</span> <span class="n">addition</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ones</span> <span class="n">it</span> <span class="n">is</span> <span class="n">handling</span><span class="p">.</span>
                                <span class="nf">newTouchTarget</span><span class="p">.</span><span class="nf">pointerIdBits</span> <span class="o">|=</span> <span class="n">idBitsToAssign</span><span class="p">;</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="p">}</span>

                            <span class="n">resetCancelNextUpFlag</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
                            <span class="sr">//</span> <span class="err">消费事件</span><span class="no">View</span><span class="err">资格</span><span class="mi">2</span><span class="err">：自己或者子</span><span class="no">View</span><span class="err">树消费事件。进入递归事件分发。</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">dispatchTransformedTouchEvent</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">idBitsToAssign</span><span class="p">))</span> <span class="p">{</span>
                                <span class="sr">//</span> <span class="no">Child</span> <span class="n">wants</span> <span class="n">to</span> <span class="n">receive</span> <span class="n">touch</span> <span class="n">within</span> <span class="n">its</span> <span class="n">bounds</span><span class="p">.</span>
                                <span class="nf">mLastTouchDownTime</span> <span class="o">=</span> <span class="n">ev</span><span class="p">.</span><span class="nf">getDownTime</span><span class="p">();</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">preorderedList</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="sr">//</span> <span class="n">childIndex</span> <span class="n">points</span> <span class="n">into</span> <span class="n">presorted</span> <span class="n">list</span><span class="p">,</span> <span class="n">find</span> <span class="n">original</span> <span class="n">index</span>
                                    <span class="k">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">childrenCount</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="n">childIndex</span><span class="p">]</span> <span class="o">==</span> <span class="n">mChildren</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
                                            <span class="n">mLastTouchDownIndex</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                                            <span class="k">break</span><span class="p">;</span>
                                        <span class="p">}</span>
                                    <span class="p">}</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                    <span class="n">mLastTouchDownIndex</span> <span class="o">=</span> <span class="n">childIndex</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="n">mLastTouchDownX</span> <span class="o">=</span> <span class="n">ev</span><span class="p">.</span><span class="nf">getX</span><span class="p">();</span>
                                <span class="n">mLastTouchDownY</span> <span class="o">=</span> <span class="n">ev</span><span class="p">.</span><span class="nf">getY</span><span class="p">();</span>
                                <span class="sr">//</span> <span class="err">标记当前</span><span class="no">View</span><span class="err">为目标消费子</span><span class="no">View</span><span class="err">，消费路径上都是父</span><span class="no">View</span><span class="err">标记直接子</span><span class="no">View</span><span class="err">（下发分发不用再找了）。不存在跨级。</span>
                                <span class="sr">//</span> <span class="err">我也没有搞明白为啥整一个链式结构存目标消费子</span><span class="no">View</span><span class="err">。我没有遇到多余</span><span class="mi">1</span><span class="err">个目标消费子</span><span class="no">View</span><span class="err">的情况。【看逻辑，如果有子</span><span class="no">View</span><span class="err">消费，则跳出循环，不会继续分发】</span>
                                <span class="n">newTouchTarget</span> <span class="o">=</span> <span class="n">addTouchTarget</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">idBitsToAssign</span><span class="p">);</span>
                                <span class="n">alreadyDispatchedToNewTouchTarget</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="p">}</span>

                            <span class="sr">//</span> <span class="no">The</span> <span class="n">accessibility</span> <span class="n">focus</span> <span class="n">didn</span><span class="s1">'t handle the event, so clear
                            // the flag and do a normal dispatch to all children.
                            ev.setTargetAccessibilityFocus(false);
                        }
                        if (preorderedList != null) preorderedList.clear();
                    }

                    if (newTouchTarget == null &amp;&amp; mFirstTouchTarget != null) {
                        // Did not find a child to receive the event.
                        // Assign the pointer to the least recently added target.
                        newTouchTarget = mFirstTouchTarget;
                        while (newTouchTarget.next != null) {
                            newTouchTarget = newTouchTarget.next;
                        }
                        newTouchTarget.pointerIdBits |= idBitsToAssign;
                    }
                }
            }

            // Dispatch to touch targets.
            // 没有目标子View消费，自己消费。（要么自己拦截了，要么子View树没有消费）
            if (mFirstTouchTarget == null) {
                // No touch targets so treat this as an ordinary view.
                handled = dispatchTransformedTouchEvent(ev, canceled, null,
                        TouchTarget.ALL_POINTER_IDS);
            } else {
                // Dispatch to touch targets, excluding the new touch target if we already
                // dispatched to it.  Cancel touch targets if necessary.
                TouchTarget predecessor = null;
                TouchTarget target = mFirstTouchTarget;
                while (target != null) {
                    final TouchTarget next = target.next;
                    // 如果是按下事件，则已消费，直接置消费状态为true
                    if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) {
                        handled = true;
                    } else {
                        final boolean cancelChild = resetCancelNextUpFlag(target.child)
                                || intercepted;
                        // 非按下事件，要么持续正常处理消费，要么被拦截（事件转成取消事件，还是继续分发给目标View）
                        if (dispatchTransformedTouchEvent(ev, cancelChild,
                                target.child, target.pointerIdBits)) {
                            handled = true;
                        }
                        if (cancelChild) {
                            // 如果是取消事件（要么被拦截，要么传过来的就是取消事件），则清空目标消费子View。
                            if (predecessor == null) {
                                mFirstTouchTarget = next;
                            } else {
                                predecessor.next = next;
                            }
                            target.recycle();
                            target = next;
                            continue;
                        }
                    }
                    predecessor = target;
                    target = next;
                }
            }

            // Update list of touch targets for pointer up or cancel, if needed.
            if (canceled
                    || actionMasked == MotionEvent.ACTION_UP
                    || actionMasked == MotionEvent.ACTION_HOVER_MOVE) {
                resetTouchState();
            } else if (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) {
                final int actionIndex = ev.getActionIndex();
                final int idBitsToRemove = 1 &lt;&lt; ev.getPointerId(actionIndex);
                removePointersFromTouchTargets(idBitsToRemove);
            }
        }

        if (!handled &amp;&amp; mInputEventConsistencyVerifier != null) {
            mInputEventConsistencyVerifier.onUnhandledEvent(ev, 1);
        }
        // 返回消费状态
        return handled;
    }

    // 拦截处理
    public boolean onInterceptTouchEvent(MotionEvent ev) {
        if (ev.isFromSource(InputDevice.SOURCE_MOUSE)
                &amp;&amp; ev.getAction() == MotionEvent.ACTION_DOWN
                &amp;&amp; ev.isButtonPressed(MotionEvent.BUTTON_PRIMARY)
                &amp;&amp; isOnScrollbarThumb(ev.getX(), ev.getY())) {
            return true;
        }
        return false;
    }

    // 事件分发处理封装部分逻辑的子方法，实现取消事件转换
    private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,
            View child, int desiredPointerIdBits) {
        final boolean handled;

        // Canceling motions is a special case.  We don'</span><span class="n">t</span> <span class="n">need</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">any</span> <span class="n">transformations</span>
        <span class="sr">//</span> <span class="n">or</span> <span class="n">filtering</span><span class="o">.</span>  <span class="no">The</span> <span class="n">important</span> <span class="n">part</span> <span class="n">is</span> <span class="n">the</span> <span class="n">action</span><span class="p">,</span> <span class="n">not</span> <span class="n">the</span> <span class="n">contents</span><span class="p">.</span>
        <span class="nf">final</span> <span class="n">int</span> <span class="n">oldAction</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">getAction</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cancel</span> <span class="o">||</span> <span class="n">oldAction</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_CANCEL</span><span class="p">)</span> <span class="p">{</span>
            <span class="sr">//</span> <span class="err">转换成取消事件</span>
            <span class="n">event</span><span class="p">.</span><span class="nf">setAction</span><span class="p">(</span><span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_CANCEL</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">handled</span> <span class="o">=</span> <span class="k">super</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">handled</span> <span class="o">=</span> <span class="n">child</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">event</span><span class="p">.</span><span class="nf">setAction</span><span class="p">(</span><span class="n">oldAction</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="sr">//</span> <span class="no">Calculate</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">pointers</span> <span class="n">to</span> <span class="n">deliver</span><span class="p">.</span>
        <span class="nf">final</span> <span class="n">int</span> <span class="n">oldPointerIdBits</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">getPointerIdBits</span><span class="p">();</span>
        <span class="n">final</span> <span class="n">int</span> <span class="n">newPointerIdBits</span> <span class="o">=</span> <span class="n">oldPointerIdBits</span> <span class="o">&amp;</span> <span class="n">desiredPointerIdBits</span><span class="p">;</span>

        <span class="sr">//</span> <span class="no">If</span> <span class="k">for</span> <span class="n">some</span> <span class="n">reason</span> <span class="n">we</span> <span class="n">ended</span> <span class="n">up</span> <span class="k">in</span> <span class="n">an</span> <span class="n">inconsistent</span> <span class="n">state</span> <span class="n">where</span> <span class="n">it</span> <span class="n">looks</span> <span class="n">like</span> <span class="n">we</span>
        <span class="sr">//</span> <span class="n">might</span> <span class="n">produce</span> <span class="n">a</span> <span class="n">motion</span> <span class="n">event</span> <span class="n">with</span> <span class="n">no</span> <span class="n">pointers</span> <span class="k">in</span> <span class="n">it</span><span class="p">,</span> <span class="k">then</span> <span class="n">drop</span> <span class="n">the</span> <span class="n">event</span><span class="p">.</span>
        <span class="nf">if</span> <span class="p">(</span><span class="n">newPointerIdBits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kp">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="sr">//</span> <span class="no">If</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">pointers</span> <span class="n">is</span> <span class="n">the</span> <span class="n">same</span> <span class="n">and</span> <span class="n">we</span> <span class="n">don</span><span class="err">'</span><span class="n">t</span> <span class="n">need</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">any</span> <span class="n">fancy</span>
        <span class="sr">//</span> <span class="n">irreversible</span> <span class="n">transformations</span><span class="p">,</span> <span class="k">then</span> <span class="n">we</span> <span class="n">can</span> <span class="n">reuse</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">event</span> <span class="k">for</span> <span class="n">this</span>
        <span class="sr">//</span> <span class="n">dispatch</span> <span class="n">as</span> <span class="n">long</span> <span class="n">as</span> <span class="n">we</span> <span class="n">are</span> <span class="n">careful</span> <span class="n">to</span> <span class="n">revert</span> <span class="n">any</span> <span class="n">changes</span> <span class="n">we</span> <span class="n">make</span><span class="p">.</span>
        <span class="nf">/</span><span class="o">/</span> <span class="no">Otherwise</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">make</span> <span class="n">a</span> <span class="n">copy</span><span class="p">.</span>
        <span class="nf">final</span> <span class="no">MotionEvent</span> <span class="n">transformedEvent</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newPointerIdBits</span> <span class="o">==</span> <span class="n">oldPointerIdBits</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="n">null</span> <span class="o">||</span> <span class="n">child</span><span class="p">.</span><span class="nf">hasIdentityMatrix</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">handled</span> <span class="o">=</span> <span class="k">super</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">final</span> <span class="n">float</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="n">mScrollX</span> <span class="o">-</span> <span class="n">child</span><span class="p">.</span><span class="nf">mLeft</span><span class="p">;</span>
                    <span class="n">final</span> <span class="n">float</span> <span class="n">offsetY</span> <span class="o">=</span> <span class="n">mScrollY</span> <span class="o">-</span> <span class="n">child</span><span class="p">.</span><span class="nf">mTop</span><span class="p">;</span>
                    <span class="n">event</span><span class="p">.</span><span class="nf">offsetLocation</span><span class="p">(</span><span class="n">offsetX</span><span class="p">,</span> <span class="n">offsetY</span><span class="p">);</span>

                    <span class="n">handled</span> <span class="o">=</span> <span class="n">child</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

                    <span class="n">event</span><span class="p">.</span><span class="nf">offsetLocation</span><span class="p">(</span><span class="o">-</span><span class="n">offsetX</span><span class="p">,</span> <span class="o">-</span><span class="n">offsetY</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">transformedEvent</span> <span class="o">=</span> <span class="no">MotionEvent</span><span class="p">.</span><span class="nf">obtain</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">transformedEvent</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">newPointerIdBits</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="sr">//</span> <span class="no">Perform</span> <span class="n">any</span> <span class="n">necessary</span> <span class="n">transformations</span> <span class="n">and</span> <span class="n">dispatch</span><span class="p">.</span>
        <span class="nf">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">handled</span> <span class="o">=</span> <span class="k">super</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">transformedEvent</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">final</span> <span class="n">float</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="n">mScrollX</span> <span class="o">-</span> <span class="n">child</span><span class="p">.</span><span class="nf">mLeft</span><span class="p">;</span>
            <span class="n">final</span> <span class="n">float</span> <span class="n">offsetY</span> <span class="o">=</span> <span class="n">mScrollY</span> <span class="o">-</span> <span class="n">child</span><span class="p">.</span><span class="nf">mTop</span><span class="p">;</span>
            <span class="n">transformedEvent</span><span class="p">.</span><span class="nf">offsetLocation</span><span class="p">(</span><span class="n">offsetX</span><span class="p">,</span> <span class="n">offsetY</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">child</span><span class="p">.</span><span class="nf">hasIdentityMatrix</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">transformedEvent</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="nf">getInverseMatrix</span><span class="p">());</span>
            <span class="p">}</span>

            <span class="n">handled</span> <span class="o">=</span> <span class="n">child</span><span class="p">.</span><span class="nf">dispatchTouchEvent</span><span class="p">(</span><span class="n">transformedEvent</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="sr">//</span> <span class="no">Done</span><span class="p">.</span>
        <span class="nf">transformedEvent</span><span class="p">.</span><span class="nf">recycle</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
<p><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6DispatchTouchEvent%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="事件DispatchTouchEvent流程图"></p>

<h5 id="view">View</h5>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="kp">public</span> <span class="k">class</span> <span class="nc">View</span>  <span class="p">{</span>
    <span class="kp">public</span> <span class="n">final</span> <span class="n">boolean</span> <span class="n">dispatchPointerEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="sr">//</span> <span class="no">View</span><span class="err">树接收事件的起点，由</span><span class="no">ViewRootImpl</span><span class="err">调用</span><span class="no">DecorView</span><span class="err">的该方法开始，</span>
        <span class="sr">//</span> <span class="err">接下来会调用到</span><span class="no">DecorView</span><span class="err">的</span><span class="n">dispatchTouchEvent</span><span class="err">方法。</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">isTouchEvent</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">dispatchTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">dispatchGenericMotionEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="sr">//</span> <span class="err">事件消费处理</span>
    <span class="kp">public</span> <span class="n">boolean</span> <span class="n">dispatchTouchEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="sr">//</span> <span class="no">If</span> <span class="n">the</span> <span class="n">event</span> <span class="n">should</span> <span class="n">be</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">accessibility</span> <span class="n">focus</span> <span class="n">first</span><span class="p">.</span>
        <span class="nf">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">isTargetAccessibilityFocus</span><span class="p">())</span> <span class="p">{</span>
            <span class="sr">//</span> <span class="no">We</span> <span class="n">don</span><span class="s1">'t have focus or no virtual descendant has it, do not handle the event.
            if (!isAccessibilityFocusedViewOrHost()) {
                return false;
            }
            // We have focus and got the event, then use normal event dispatch.
            event.setTargetAccessibilityFocus(false);
        }

        boolean result = false;

        if (mInputEventConsistencyVerifier != null) {
            mInputEventConsistencyVerifier.onTouchEvent(event, 0);
        }

        final int actionMasked = event.getActionMasked();
        if (actionMasked == MotionEvent.ACTION_DOWN) {
            // Defensive cleanup for new gesture
            stopNestedScroll();
        }

        if (onFilterTouchEventForSecurity(event)) {
            if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) {
                result = true;
            }
            //noinspection SimplifiableIfStatement
            ListenerInfo li = mListenerInfo;
            // 优先mOnTouchListener消费处理，如果消费，直接返回已消费
            if (li != null &amp;&amp; li.mOnTouchListener != null
                    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED
                    &amp;&amp; li.mOnTouchListener.onTouch(this, event)) {
                result = true;
            }

            // 自己处理消费，封装在onTouchEvent内
            if (!result &amp;&amp; onTouchEvent(event)) {
                result = true;
            }
        }

        if (!result &amp;&amp; mInputEventConsistencyVerifier != null) {
            mInputEventConsistencyVerifier.onUnhandledEvent(event, 0);
        }

        // Clean up after nested scrolls if this is the end of a gesture;
        // also cancel it if we tried an ACTION_DOWN but we didn'</span><span class="n">t</span> <span class="n">want</span> <span class="n">the</span> <span class="n">rest</span>
        <span class="sr">//</span> <span class="n">of</span> <span class="n">the</span> <span class="n">gesture</span><span class="p">.</span>
        <span class="nf">if</span> <span class="p">(</span><span class="n">actionMasked</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_UP</span> <span class="o">||</span>
                <span class="n">actionMasked</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_CANCEL</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">actionMasked</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_DOWN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">stopNestedScroll</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sr">//</span> <span class="err">针对完整事件流（</span><span class="no">ACTION</span><span class="p">\</span><span class="n">_DOWN</span> <span class="o">-&gt;</span> <span class="no">ACTION</span><span class="p">\</span><span class="n">_MOVE</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="no">ACTION</span><span class="p">\</span><span class="n">_UP</span><span class="o">/</span><span class="no">ACTION</span><span class="p">\</span><span class="n">_CANCEL</span><span class="err">）完成按键监听、长时间按键监听、焦点以及按键状态处理。</span>
    <span class="kp">public</span> <span class="n">boolean</span> <span class="n">onTouchEvent</span><span class="p">(</span><span class="no">MotionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">final</span> <span class="n">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">getX</span><span class="p">();</span>
        <span class="n">final</span> <span class="n">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">getY</span><span class="p">();</span>
        <span class="n">final</span> <span class="n">int</span> <span class="n">viewFlags</span> <span class="o">=</span> <span class="n">mViewFlags</span><span class="p">;</span>
        <span class="n">final</span> <span class="n">int</span> <span class="n">action</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">getAction</span><span class="p">();</span>

        <span class="n">final</span> <span class="n">boolean</span> <span class="n">clickable</span> <span class="o">=</span> <span class="p">((</span><span class="n">viewFlags</span> <span class="o">&amp;</span> <span class="no">CLICKABLE</span><span class="p">)</span> <span class="o">==</span> <span class="no">CLICKABLE</span>
                <span class="o">||</span> <span class="p">(</span><span class="n">viewFlags</span> <span class="o">&amp;</span> <span class="no">LONG_CLICKABLE</span><span class="p">)</span> <span class="o">==</span> <span class="no">LONG_CLICKABLE</span><span class="p">)</span>
                <span class="o">||</span> <span class="p">(</span><span class="n">viewFlags</span> <span class="o">&amp;</span> <span class="no">CONTEXT_CLICKABLE</span><span class="p">)</span> <span class="o">==</span> <span class="no">CONTEXT_CLICKABLE</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">viewFlags</span> <span class="o">&amp;</span> <span class="no">ENABLED_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="no">DISABLED</span><span class="p">)</span> <span class="p">{</span>
            <span class="sr">//</span> <span class="err">按键未启用，直接返回点击状态。</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_UP</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mPrivateFlags</span> <span class="o">&amp;</span> <span class="no">PFLAG_PRESSED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">setPressed</span><span class="p">(</span><span class="kp">false</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">mPrivateFlags3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="no">PFLAG3_FINGER_DOWN</span><span class="p">;</span>
            <span class="sr">//</span> <span class="no">A</span> <span class="n">disabled</span> <span class="n">view</span> <span class="n">that</span> <span class="n">is</span> <span class="n">clickable</span> <span class="n">still</span> <span class="n">consumes</span> <span class="n">the</span> <span class="n">touch</span>
            <span class="sr">//</span> <span class="n">events</span><span class="p">,</span> <span class="n">it</span> <span class="n">just</span> <span class="n">doesn</span><span class="s1">'t respond to them.
            return clickable;
        }
        // 有效触摸代理消费事件，可用于扩大点击热点控制。如果消费，直接返回已消费。
        if (mTouchDelegate != null) {
            if (mTouchDelegate.onTouchEvent(event)) {
                return true;
            }
        }

        if (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) {
            // 可点击情况下进行按键处理。
            switch (action) {
                case MotionEvent.ACTION_UP:
                    mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;
                    if ((viewFlags &amp; TOOLTIP) == TOOLTIP) {
                        handleTooltipUp();
                    }
                    if (!clickable) {
                        removeTapCallback();
                        removeLongPressCallback();
                        mInContextButtonPress = false;
                        mHasPerformedLongPress = false;
                        mIgnoreNextUpEvent = false;
                        break;
                    }
                    boolean prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != 0;
                    // 检查按键标志位状态，只有为按下状态才接着处理。
                    if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0 || prepressed) {
                        // take focus if we don'</span><span class="n">t</span> <span class="n">have</span> <span class="n">it</span> <span class="n">already</span> <span class="n">and</span> <span class="n">we</span> <span class="n">should</span> <span class="k">in</span>
                        <span class="sr">//</span> <span class="n">touch</span> <span class="n">mode</span><span class="p">.</span>
                        <span class="nf">boolean</span> <span class="n">focusTaken</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">isFocusable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">isFocusableInTouchMode</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isFocused</span><span class="p">())</span> <span class="p">{</span>
                            <span class="n">focusTaken</span> <span class="o">=</span> <span class="n">requestFocus</span><span class="p">();</span>
                        <span class="p">}</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">prepressed</span><span class="p">)</span> <span class="p">{</span>
                            <span class="sr">//</span> <span class="no">The</span> <span class="n">button</span> <span class="n">is</span> <span class="n">being</span> <span class="n">released</span> <span class="n">before</span> <span class="n">we</span> <span class="n">actually</span>
                            <span class="sr">//</span> <span class="n">showed</span> <span class="n">it</span> <span class="n">as</span> <span class="n">pressed</span><span class="o">.</span>  <span class="no">Make</span> <span class="n">it</span> <span class="n">show</span> <span class="n">the</span> <span class="n">pressed</span>
                            <span class="sr">//</span> <span class="n">state</span> <span class="n">now</span> <span class="p">(</span><span class="n">before</span> <span class="n">scheduling</span> <span class="n">the</span> <span class="n">click</span><span class="p">)</span> <span class="n">to</span> <span class="k">ensure</span>
                            <span class="sr">//</span> <span class="n">the</span> <span class="n">user</span> <span class="n">sees</span> <span class="n">it</span><span class="p">.</span>
                            <span class="nf">setPressed</span><span class="p">(</span><span class="kp">true</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                        <span class="p">}</span>

                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mHasPerformedLongPress</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mIgnoreNextUpEvent</span><span class="p">)</span> <span class="p">{</span>
                            <span class="sr">//</span> <span class="no">This</span> <span class="n">is</span> <span class="n">a</span> <span class="n">tap</span><span class="p">,</span> <span class="n">so</span> <span class="n">remove</span> <span class="n">the</span> <span class="n">longpress</span> <span class="n">check</span>
                            <span class="sr">//</span> <span class="no">ACTION_DOWN</span><span class="err">触发的长按点击事件还未执行，则移除长按点击事件，</span>
                            <span class="n">removeLongPressCallback</span><span class="p">();</span>

                            <span class="sr">//</span> <span class="no">Only</span> <span class="n">perform</span> <span class="n">take</span> <span class="n">click</span> <span class="n">actions</span> <span class="k">if</span> <span class="n">we</span> <span class="n">were</span> <span class="k">in</span> <span class="n">the</span> <span class="n">pressed</span> <span class="n">state</span>
                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">focusTaken</span><span class="p">)</span> <span class="p">{</span>
                                <span class="sr">//</span> <span class="no">Use</span> <span class="n">a</span> <span class="no">Runnable</span> <span class="n">and</span> <span class="n">post</span> <span class="n">this</span> <span class="n">rather</span> <span class="n">than</span> <span class="n">calling</span>
                                <span class="sr">//</span> <span class="n">performClick</span> <span class="n">directly</span><span class="o">.</span> <span class="no">This</span> <span class="n">lets</span> <span class="n">other</span> <span class="n">visual</span> <span class="n">state</span>
                                <span class="sr">//</span> <span class="n">of</span> <span class="n">the</span> <span class="n">view</span> <span class="n">update</span> <span class="n">before</span> <span class="n">click</span> <span class="n">actions</span> <span class="n">start</span><span class="p">.</span>
                                <span class="nf">if</span> <span class="p">(</span><span class="n">mPerformClick</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="n">mPerformClick</span> <span class="o">=</span> <span class="n">new</span> <span class="no">PerformClick</span><span class="p">();</span>
                                <span class="p">}</span>
                                <span class="sr">//</span> <span class="err">执行点击事件。</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">post</span><span class="p">(</span><span class="n">mPerformClick</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="n">performClick</span><span class="p">();</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">mUnsetPressedState</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">mUnsetPressedState</span> <span class="o">=</span> <span class="n">new</span> <span class="no">UnsetPressedState</span><span class="p">();</span>
                        <span class="p">}</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">prepressed</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">postDelayed</span><span class="p">(</span><span class="n">mUnsetPressedState</span><span class="p">,</span>
                                    <span class="no">ViewConfiguration</span><span class="p">.</span><span class="nf">getPressedStateDuration</span><span class="p">());</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">post</span><span class="p">(</span><span class="n">mUnsetPressedState</span><span class="p">))</span> <span class="p">{</span>
                            <span class="sr">//</span> <span class="no">If</span> <span class="n">the</span> <span class="n">post</span> <span class="n">failed</span><span class="p">,</span> <span class="n">unpress</span> <span class="n">right</span> <span class="n">now</span>
                            <span class="n">mUnsetPressedState</span><span class="p">.</span><span class="nf">run</span><span class="p">();</span>
                        <span class="p">}</span>

                        <span class="n">removeTapCallback</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="n">mIgnoreNextUpEvent</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_DOWN</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">getSource</span><span class="p">()</span> <span class="o">==</span> <span class="no">InputDevice</span><span class="o">.</span><span class="no">SOURCE_TOUCHSCREEN</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">mPrivateFlags3</span> <span class="o">|=</span> <span class="no">PFLAG3_FINGER_DOWN</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">mHasPerformedLongPress</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clickable</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">checkForLongClick</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">performButtonActionOnTouchDown</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="sr">//</span> <span class="no">Walk</span> <span class="n">up</span> <span class="n">the</span> <span class="n">hierarchy</span> <span class="n">to</span> <span class="n">determine</span> <span class="k">if</span> <span class="n">we</span><span class="err">'</span><span class="n">re</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">scrolling</span> <span class="n">container</span><span class="p">.</span>
                    <span class="nf">boolean</span> <span class="n">isInScrollingContainer</span> <span class="o">=</span> <span class="n">isInScrollingContainer</span><span class="p">();</span>

                    <span class="sr">//</span> <span class="no">For</span> <span class="n">views</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">scrolling</span> <span class="n">container</span><span class="p">,</span> <span class="n">delay</span> <span class="n">the</span> <span class="n">pressed</span> <span class="n">feedback</span> <span class="k">for</span>
                    <span class="sr">//</span> <span class="n">a</span> <span class="n">short</span> <span class="n">period</span> <span class="k">in</span> <span class="k">case</span> <span class="n">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">scroll</span><span class="p">.</span>
                    <span class="nf">/</span><span class="o">/</span> <span class="err">置按键标志位为按下状态，并触发延时（</span><span class="mi">500</span><span class="n">ms</span><span class="err">）执行长按点击事件。</span>
                    <span class="sr">//</span> <span class="err">以下为滚动和非滚动下的处理。</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">isInScrollingContainer</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">mPrivateFlags</span> <span class="o">|=</span> <span class="no">PFLAG_PREPRESSED</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">mPendingCheckForTap</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">mPendingCheckForTap</span> <span class="o">=</span> <span class="n">new</span> <span class="no">CheckForTap</span><span class="p">();</span>
                        <span class="p">}</span>
                        <span class="n">mPendingCheckForTap</span><span class="p">.</span><span class="nf">x</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">getX</span><span class="p">();</span>
                        <span class="n">mPendingCheckForTap</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">getY</span><span class="p">();</span>
                        <span class="n">postDelayed</span><span class="p">(</span><span class="n">mPendingCheckForTap</span><span class="p">,</span> <span class="no">ViewConfiguration</span><span class="p">.</span><span class="nf">getTapTimeout</span><span class="p">());</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="sr">//</span> <span class="no">Not</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">scrolling</span> <span class="n">container</span><span class="p">,</span> <span class="n">so</span> <span class="n">show</span> <span class="n">the</span> <span class="n">feedback</span> <span class="n">right</span> <span class="n">away</span>
                        <span class="n">setPressed</span><span class="p">(</span><span class="kp">true</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                        <span class="n">checkForLongClick</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_CANCEL</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">clickable</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">setPressed</span><span class="p">(</span><span class="kp">false</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="sr">//</span> <span class="err">置按键标志位为非按下状态，移除</span><span class="no">ACTION_DOWN</span><span class="err">触发的延时执行长按点击事件。</span>
                    <span class="n">removeTapCallback</span><span class="p">();</span>
                    <span class="n">removeLongPressCallback</span><span class="p">();</span>
                    <span class="n">mInContextButtonPress</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
                    <span class="n">mHasPerformedLongPress</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
                    <span class="n">mIgnoreNextUpEvent</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
                    <span class="n">mPrivateFlags3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="no">PFLAG3_FINGER_DOWN</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="no">MotionEvent</span><span class="o">.</span><span class="no">ACTION_MOVE</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">clickable</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">drawableHotspotChanged</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="sr">//</span> <span class="no">Be</span> <span class="n">lenient</span> <span class="n">about</span> <span class="n">moving</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">buttons</span>
                    <span class="sr">//</span> <span class="err">检查按键坐标是否超出该</span><span class="no">View</span><span class="err">区域。</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pointInView</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">mTouchSlop</span><span class="p">))</span> <span class="p">{</span>
                        <span class="sr">//</span> <span class="no">Outside</span> <span class="n">button</span>
                        <span class="sr">//</span> <span class="no">Remove</span> <span class="n">any</span> <span class="n">future</span> <span class="n">long</span> <span class="n">press</span><span class="o">/</span><span class="n">tap</span> <span class="n">checks</span>
                        <span class="sr">//</span> <span class="err">置按键标志位为非按下状态，并且移除</span><span class="no">ACTION</span><span class="p">\</span><span class="n">_DOWN</span><span class="err">触发的延时执行长按点击事件。</span>
                        <span class="n">removeTapCallback</span><span class="p">();</span>
                        <span class="n">removeLongPressCallback</span><span class="p">();</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">mPrivateFlags</span> <span class="o">&amp;</span> <span class="no">PFLAG_PRESSED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">setPressed</span><span class="p">(</span><span class="kp">false</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="n">mPrivateFlags3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="no">PFLAG3_FINGER_DOWN</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="kp">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kp">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
<p><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6OnTouchEvent%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="事件OnTouchEvent流程图"></p>

<h4 id="part-3786c68461ca49f">事件流</h4>

<p><strong>Demo</strong>（<a href="https://github.com/shengshuqiang/viewdispatchtouchevent">git仓库</a>）ParentInterceptTouchEventActivity页面</p>

<p>使用<a href="https://www.jianshu.com/p/d968645067d7"><strong>MECE</strong></a>（Mutually Exclusive Collectively Exhaustive，相互独立，完全穷尽）法则</p>

<p><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81MEMC%E5%9B%BE.png" alt="事件流MEMC图"></p>

<p><img src="http://localhost:4000/assets/ParentInterceptTouchEventActivity.png" alt="ParentInterceptTouchEventActivity"></p>

<p>1.父控件ACTION_DOWN拦截<br>
2.父控件消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-1.png" alt="角色事件消费状态-1">
<blockquote>
1. 接收按下事件 -DOWN-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Parent.onInterceptTouchEvent -true-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Parent.(super)dispatchTouchEvent{Parent处理消费} -DOWN-&gt;  Parent.onTouchEvent -true-&gt; Parent.dispatchTouchEvent-true-&gt; 返回消费状态true<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-1.png" alt="事件流-1"><br>
2. 接收移动事件 -MOVE-&gt; Parent.dispatchTouchEvent -MOVE-&gt; Parent.(super)dispatchTouchEvent{Parent处理消费} -MOVE-&gt; Parent.onTouchEvent -消费状态-&gt; Parent.dispatchTouchEvent -true-&gt; 返回消费状态true<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-2.png" alt="事件流-2"><br>
3. 接收释放事件 -UP-&gt; Parent.dispatchTouchEvent -UP-&gt; Parent.(super)dispatchTouchEvent{Parent处理消费} -UP-&gt; Parent.onTouchEvent -true-&gt; Parent.dispatchTouchEvent -true-&gt; 返回消费状态true<img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-3.png" alt="事件流-3"><br>
</blockquote>
1.父控件ACTION_DOWN拦截<br>
2.父控件不消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-2.png" alt="角色事件消费状态-2">
<blockquote>
4. 接收按下事件 -DOWN-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Parent.onInterceptTouchEvent -true-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Parent.(super)dispatchTouchEvent{Parent处理消费} -DOWN-&gt;  Parent.onTouchEvent -false-&gt; Parent.dispatchTouchEvent-false-&gt; 返回消费状态false<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-4.png" alt="事件流-4"><br>
5. 接收不到移动事件<br>
6. 同5
</blockquote>
1.父控件ACTION_MOVE拦截<br>
2.子控件消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-3.png" alt="角色事件消费状态-3">
<blockquote>
7. 接收按下事件 -DOWN-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Parent.onInterceptTouchEvent  -false-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Child.dispatchTouchEvent{Parent分发，遍历调用Child分发消息，Child内部递归分发消息} -DOWN-&gt; TargetChild（目标子控件，区别Child，子控件消费事件，要么是自己消费了，要么是自己的后代或者后代的后代消费了）.onTouchEvent{存在调用多个Child该方法，前提是前面的Child均返回false} -true-&gt; Child.dispatchTouchEvent -true-&gt; Parent.dispatchTouchEvent{记录目标消费Child为该View}-true-&gt; 返回消费状态true<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-7.png" alt="事件流-7"><br>
8. 接收移动事件 -MOVE-&gt; Parent.dispatchTouchEvent -MOVE-&gt; Parent.onInterceptTouchEvent  -true-&gt; Parent.dispatchTouchEvent -CANCEL-&gt; Child（目标消费Child）.dispatchTouchEvent{Child处理消费} -CANCEL-&gt;Child.onTouchEvent -消费状态-&gt; Child.dispatchTouchEvent-消费状态-&gt; 返回消费状态<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-8.png" alt="事件流-8"><br>
9. 接收释放事件 -UP-&gt; Parent.dispatchTouchEvent -UP-&gt; Parent.(super)dispatchTouchEvent{Parent处理消费} -UP-&gt; Parent.onTouchEvent -消费状态-&gt; Parent.dispatchTouchEvent -消费状态-&gt; 返回消费状态<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-9.png" alt="事件流-9">
</blockquote>
1.父控件ACTION_MOVE拦截<br>
2.子控件不消费事件<br>
3.父控件消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-4.png" alt="角色事件消费状态-4">
<blockquote>
10. 接收按下事件 -DOWN-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Parent.onInterceptTouchEvent  -false-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Child.dispatchTouchEvent{Parent分发，遍历调用Child分发消息，Child内部递归分发消息} -DOWN-&gt; TargetChild（目标子控件，区别Child，子控件处理消费事件）.onTouchEvent{满足事件坐标在控件内的子View或者子View的后代均会调用到} -false-&gt; Child.dispatchTouchEvent -false-&gt; Parent.dispatchTouchEvent{没有目标消费Child} -DOWN-&gt; Parent.(super)dispatchTouchEvent{Parent处理消费} -DOWN-&gt;  Parent.onTouchEvent -true-&gt; 返回消费状态true<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-10.png" alt="事件流-10"><br>
11. 同2<br>
12. 同3<br>
</blockquote>
1.父控件ACTION_MOVE拦截<br>
2.子控件不消费事件<br>
3.父控件不消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-5.png" alt="角色事件消费状态-5">
<blockquote>
13. 接收按下事件 -DOWN-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Parent.onInterceptTouchEvent  -false-&gt; Parent.dispatchTouchEvent -DOWN-&gt; Child.dispatchTouchEvent{Parent分发，遍历调用Child分发消息，Child内部递归分发消息} -DOWN-&gt; TargetChild（目标子控件，区别Child，子控件处理消费事件）.onTouchEvent{满足事件坐标在控件内的子View或者子View的后代均会调用到} -false-&gt; Child.dispatchTouchEvent -false-&gt; Parent.dispatchTouchEvent{没有目标消费Child} -DOWN-&gt; Parent.(super)dispatchTouchEvent{Parent处理消费} -DOWN-&gt;  Parent.onTouchEvent -false-&gt; 返回消费状态false<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-13.png" alt="事件流-13"><br>
14. 同5<br>
15. 同5<br>
</blockquote>
1.父控件ACTION_UP拦截<br>
2.子控件消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-6.png" alt="角色事件消费状态-6">
<blockquote>
16. 同7<br>
17. 接收移动事件 -MOVE-&gt; Parent.dispatchTouchEvent -MOVE-&gt; Parent.onInterceptTouchEvent  -false-&gt; Parent.dispatchTouchEvent -MOVE-&gt; Child(目标消费Child).dispatchTouchEvent -MOVE-&gt; Child.onTouchEvent -true-&gt; Child.dispatchTouchEvent -true-&gt; Parent.dispatchTouchEvent -true-&gt; 返回消费状态true<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-17.png" alt="事件流-17"><br>
18. 接收释放事件 -UP-&gt; Parent.dispatchTouchEvent -UP-&gt; Parent.onInterceptTouchEvent -true-&gt; Parent.dispatchTouchEvent -CANCEL-&gt; Child(目标消费Child).dispatchTouchEvent{Child处理消费} -CANCEL-&gt; Child.onTouchEvent -消费状态-&gt; Child.dispatchTouchEvent -true-&gt; Parent.dispatchTouchEvent -true-&gt; 返回消费状态true<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-18.png" alt="事件流-18">
</blockquote>
1.父控件ACTION_UP拦截<br>
2.子控件不消费事件<br>
3.父控件消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-7.png" alt="角色事件消费状态-7">
<blockquote>
19. 同10<br>
20. 同2<br>
21. 同3<br>
</blockquote>
1.父控件ACTION_UP拦截<br>
2.子控件不消费事件<br>
3.父控件不消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-8.png" alt="角色事件消费状态-8">
<blockquote>
22. 同13<br>
23. 同5<br>
24. 同5
</blockquote>
1. 父控件不拦截<br>
2. 子控件消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-9.png" alt="角色事件消费状态-9">
<blockquote>
25. 同7<br>
26. 同17<br>
27. 接收释放事件 -UP-&gt; Parent.dispatchTouchEvent -UP-&gt; Parent.onInterceptTouchEvent  -false-&gt; Parent.dispatchTouchEvent -UP-&gt; Child(目标消费Child).dispatchTouchEvent -UP-&gt; Child.onTouchEvent -true-&gt; Child.dispatchTouchEvent -true-&gt; Parent.dispatchTouchEvent -true-&gt; 返回消费状态true<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E6%B5%81-27.png" alt="事件流-27">
</blockquote>
1. 父控件不拦截<br>
2. 子控件不消费事件<br>
3. 父控件消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-10.png" alt="角色事件消费状态-10">
<blockquote>
28. 同10<br>
29. 同2<br>
30. 同3<br>
</blockquote>
1. 父控件不拦截<br>
2. 子控件不消费事件<br>
3. 父控件不消费事件<br><img src="http://localhost:4000/assets/%E8%A7%92%E8%89%B2%E4%BA%8B%E4%BB%B6%E6%B6%88%E8%B4%B9%E7%8A%B6%E6%80%81-11.png" alt="角色事件消费状态-11">
<blockquote>
31. 同13<br>
32. 同5<br>
33. 同5<br>
</blockquote>
</blockquote></p>

<p><strong>启示</strong></p>

<ol>
<li>ACTION_DOWN执行事件分发查找（遍历子View，递归分发查找，如果子View未消费，则回退到自己消费，依次向上回溯，找到目标消费View为止）找到目标消费子View。后续事件不再需要查找，直接发送给目标消费子View，如果没有，则自己消费。<br><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E8%B7%AF%E5%BE%84.png" alt="事件分发路径"></li>
<li>事件已消费路径上（终点为目标消费View），如果有父控件拦截事件，则第一次拦截后，会将当前事件转为ACTION_CANCEL传递给目标消费子View，后续事件则直接自己处理消费，不论是否消费，均能收到后续事件流<br> <img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%8B%A6%E6%88%AA%E8%B7%AF%E5%BE%84.png" alt="事件分发拦截路径"></li>
</ol>

<h3 id="part-65431c26ecd">论证</h3>

<ol>
<li>从事件流可证明事件一致性保证(Consistency Guarantees)：

<ol>
<li>ViewGroup在ACTION_DOWN的事件分发返回false（不消费事件），则不再会收到后续事件（ACTION_MOVE、ACTION_UP/ACTION_CANCEL）。</li>
<li>ViewGroup在ACTION_DOWN的事件分发返回true（消费事件），则会收到后续事件（ACTION_MOVE、ACTION_UP/ACTION_CANCEL），如果ViewGroup拦截后续事件，则第一次拦截会将事件转为ACTION_CANCEL传递给目标消费子View（终止子View接收后续事件），接下来的后续事件自己消费。</li>
<li> ViewGroup在非ACTION_DOWN的事件分发返回消费状态对整体事件流没有影响。</li>
</ol></li>
<li>从注释可证明View.dispatchTouchEvent方法完成事件的消费处理；ViewGroup.dispatchTouchEvent方法完成事件的分发处理；ViewGroup.onInterceptTouchEvent方法完成事件的拦截处理；事件分发路径上的ViewGroup，在ACTION_DOWN或者不是自己直接消费事件时一定会调用onInterceptTouchEvent方法。以及View类的onTouchEvent方法完成具体处理事件消费。</li>
</ol>

<h2 id="part-3786c5121338800">一张图</h2>

<p><img src="http://localhost:4000/assets/%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E4%B8%80%E5%BC%A0%E5%9B%BE.png" alt="事件分发一张图"></p>

<p><strong>赏析</strong></p>

<ol>
<li>ACTION_DOWN会触发查找目标消费View，优先子View尝试消费，如果子View仍然没有消费，则依次回溯到父控件尝试消费（直至DecorView，然后Activity尝试消费），如果找到了，则回溯返回true。</li>
<li>ACTION_DOWN后续事件执行的前提是事件分发路径的终点就是目标消费View，目标消费View的父控件均会调用到事件拦截（让父控件有机会拦截下来，改变事件流），如果目标消费View的父控件拦截，拦截时的事件会转换为ACTION_CANCEL继续按原路径分发，后续的事件则不再分发给目标消费View，而是拦截的父控件自己消费。</li>
<li>非ACTION_DOWN返回的消费状态对事件流没有影响，如果未消费，会回调给Activity处理。</li>
</ol>

<h2 id="part-6542bfebd44">标准</h2>

<h3 id="part-2c9a377a88b0c4e6">常见错误</h3>

<ol>
<li>不知道onInterceptTouchEvent和onTouchEvent什么时候会调用，但是知道dispatchTouchEvent每次都会调用，就把逻辑直接写在dispatchTouchEvent的重写方法里面。<br>问题：不满足事件流一致性，存在目标消费View没有接收到ACTION_UP/ACTION_CANCEL就结束了，导致焦点、按键状态或者按键事件不符合预期。</li>
<li>发现onInterceptTouchEvent经常调用到，逻辑写在onInterceptTouchEvent里面。<br>问题：onInterceptTouchEvent在View自己消费情况下或者拦截之后的事件流不再会调用到，会把坑隐藏得更深【不好复现的Bug才是最难解决的Bug】。</li>
<li>鸟枪法，dispatchTouchEvent、onInterceptTouchEvent、onTouchEvent均会调用到逻辑。<br>问题：路子太野。。。</li>
<li>觉得自己很牛X，逻辑分散在dispatchTouchEvent、onInterceptTouchEvent、onTouchEvent里面。<br>问题：可读性差，逻辑混乱。</li>
<li>事件消息只处理了ACTION_DOWN、ACTION_MOVE、ACTION_UP，没有对ACTION_CANCEL或者其他多点触控事件容错处理。<br>问题：总会出现不常见的问题。</li>
</ol>

<h3 id="part-2cac2c45be4b8e80">最佳实践</h3>

<ol>
<li>明确事件流调用顺序以及拦截后的事件流。</li>
<li>dispatchTouchEvent：正常情况下不建议重写dispatchTouchEvent方法改变系统事件分发机制，可以看到，Google就没有几个类重新该方法。最多记下坐标点，但千万调用super. dispatchTouchEvent保证系统事件分发正常调用。</li>
<li>onInterceptTouchEvent：只处理拦截逻辑，在合适事件将事件流导到onTouchEvent。</li>
<li>onTouchEvent：真正处理逻辑。</li>
<li>除常见事件处理外，一定要上剩余事件容错处理。</li>
</ol>

<h2 id="part-b8a9d97">渔</h2>

<h3 id="part-3786d9fced1fe38">方法论</h3>

<ol>
<li> <a href="https://www.jianshu.com/p/d968645067d7">MECE法则和金字塔原理</a></li>
<li> <a href="https://www.zhihu.com/question/27880205">SCQA 架构如何理解？</a></li>
</ol>

<h3 id="part-6542809efe1">利器</h3>

<ol>
<li>AS源码英文翻译，参考<a href="http://blog.csdn.net/luofen521/article/details/74295716">AS翻译插件Translation</a></li>
<li>Android源码调试

<ol>
<li><a href="http://www.genymotion.net/">Android模拟器GenyMotion</a> </li>
<li>GenyMotion创建和App的build.gradle中targetSdkVersion相同API Level模拟器即可Debug对应上源码。进阶参考<a href="http://weishu.me/2016/05/30/how-to-debug-android-framework/">如何调试Android Framework？</a></li>
<li><a href="http://weishu.me/2015/12/21/android-studio-debug-tips-you-may-not-know/">Android Studio你不知道的调试技巧</a></li>
</ol></li>
<li>关键日志输出，使用静态代理，进阶参考<a href="http://weishu.me/2016/01/28/understand-plugin-framework-proxy-hook/">Android插件化原理解析——Hook机制之动态代理</a></li>
<li>绘图工具

<ol>
<li><a href="https://www.processon.com/i/5a633502e4b0332f153dd897">ProcessOn</a></li>
<li><a href="https://www.edrawsoft.com/download-edrawmax-mac.php">edraw</a></li>
</ol></li>
<li>个人主页

<ol>
<li><a href="https://www.jekyll.com.cn/">将纯文本转化为静态网站和博客</a></li>
<li><a href="https://www.zhihu.com/question/20409634">怎样引导新手使用 Markdown？</a></li>
</ol></li>
</ol>

<h1 id="part-b8a933b">利</h1>

<ol>
<li>随心所欲控制事件流【大权在手，天下我有】</li>
<li>事件分发不再是个事，怕个球</li>
<li>各种酷炫动画和自定义控件燥起来</li>
<li>再也不用担心面试中尬聊事件分发</li>
<li>借鉴上述不成熟的“渔”去爱干嘛干嘛</li>
</ol>

<h1 id="part-65432e5111e">进阶</h1>

<ol>
<li>滚动控件和按键冲突处理，界面布局滚动</li>
<li>滑动冲突 

<ol>
<li><a href="https://segmentfault.com/a/1190000002873657">NestedScrolling机制</a></li>
<li><a href="http://blog.csdn.net/lmj623565791/article/details/52204039">Android NestedScrolling机制完全解析 带你玩转嵌套滑动</a></li>
<li><a href="https://www.jianshu.com/p/982a83271327">外部拦截法&amp;内部拦截法</a></li>
</ol></li>
<li>手势（GestureDecetor）</li>
</ol>

<h1 id="part-65428734206">参考</h1>

<ol>
<li><a href="https://www.jianshu.com/p/e99b5e8bd67b">图解 Android 事件分发机制</a></li>
<li><a href="http://blog.ingphone.com/android/2013/11/13/Android-%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6.html">Android 响应用户屏幕手势操作</a></li>
<li><a href="https://www.jianshu.com/p/0c863bbde8eb">Android MotionEvent详解</a></li>
<li><a href="https://my.oschina.net/banxi/blog/56421">android触控,先了解MotionEvent(一)</a></li>
<li><a href="http://blog.csdn.net/woshimalingyi/article/details/50383578">Android多点触控之——MotionEvent(触控事件)</a></li>
<li><a href="http://ztelur.github.io/2016/02/04/%E5%9B%BE%E8%A7%A3Android%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E4%B9%8BView%E7%AF%87/">图解Android事件传递之View篇</a></li>
<li><a href="http://ztelur.github.io/2016/02/11/%E5%9B%BE%E8%A7%A3Android%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E4%B9%8BViewGroup%E7%AF%87/">图解Android事件传递之ViewGroup篇</a></li>
</ol>

<h1 id="part-b8a9c24">歌</h1>

<h2 id="part-c7060f19ae93e39c">念奴娇·天丁震怒</h2>

<p>完颜亮(金代)</p>

<ol>
<li>天丁震怒，掀翻银海，散乱珠箔（bó）。</li>
<li>六出奇花飞滚滚，平填了山中丘壑。(六出：雪花六角，因用为雪花的别名。)</li>
<li>皓虎颠狂，素麟猖獗(chāng jué)，掣(chè, 拉)断珍珠索。(皓虎：白色的老虎。素麟：白色的麒麟。)</li>
<li>玉龙酣战，鳞甲满天飘落。</li>
<li><br></li>
<li>谁念万里关山，征夫僵立，缟（gǎo）带沾旗脚。(僵立：因寒冷而冻得僵硬直立。缟带：白色的衣带。)</li>
<li>色映戈矛，光摇剑戟(jǐ )，杀气横戎幕。(戎幕：行军作战时的营帐。)</li>
<li>貔（pí）虎豪雄，偏裨（pí）英勇，共与谈兵略。（裨：pí ，副，偏，小；bì ，增添，补助，如大有～益。）</li>
<li>须拼一醉，看取碧空寥廓(liáo kuò)。</li>
</ol>

<h1 id="copy-right">Copy Right</h1>

<ul>
<li>作者： 盛书强，美团点评酒旅前端高级工程师，“九域之广,岂一人之强化,必伫才能,共成羽翼”，我们期待你的加入，简历发送至shengshuqiang@gmail.com。 </li>
<li>声明： 本文为原创文章，转载请注明来源，共建和谐。</li>
</ul>

  </article>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Older</span>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2018-02-10T17:02:13+08:00">2018</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
